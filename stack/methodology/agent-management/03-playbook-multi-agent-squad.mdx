# 03 Playbook：多 Agent 编队协作（Multi-Agent Squad）

> 目标：把并行变成吞吐，而不是混乱。通过任务分片、合并策略与评审门禁，实现“人机编队”的高效产出。

---

## 🧠 核心洞见

1️⃣ **“多 Agent 協作的最大敵人是上下文漂移與邏輯衝突。”**

2️⃣ **智能體網格 (Agent AI Mesh)**
未來的技術架構將智能體的結構、邏輯與數據層與底層供應商體系隔離。通過 **Agent-to-Agent Protocols**，系統不再依賴複雜的 API 集成，而是以對話或標準化協議完成跨系統交互。

3️⃣ **從線性增長走向指數躍遷**
傳統組織受限於人類協作規模（如“兩張披薩團隊”），而智能體型組織通過去中心化的網絡架構，實現了邊際成本趨近算力成本的產出。

---

## 1. 組織模式（Squad Patterns）

### 1.1 串行接力（Pipeline）
- **场景**：需求明确的线性任务（研究 → 规格 → 实现）。
- **管理点**：定义清晰的交接物（Handoffs），见 01 角色分工。

### 1.2 并行分片（Sharding）
- **场景**：大模块重构、多文档更新。
- **管理点**：
  - **物理隔离**：每个 Agent 分配独立的目录或文件列表。
  - **接口定义**：在开始前，由 Planner 定义好公共接口，各執行者不得私自更改。

### 1.3 镜像对决（Mirror/Red-Blue）
- **场景**：高风险算法、安全加固。
- **管理点**：两个 Agent 独立实现，由 Reviewer 對比 Diff。

---

## 2. 协作流程（Multi-Agent SOP）

### 第一阶段：任务分片（Sharding）
- **指挥官指令**：明确总目标。
- **规划官输出**：
  - `tasks.md`：拆分为原子任务。
  - `dependency_graph.md`：标识任务间的依赖关系。
  - **分配策略**：Agent A 处理 `docs/tools/`，Agent B 处理 `docs/capabilities/`。

### 第二阶段：执行隔离（Sandbox Execution）
- 每个 Agent 在独立的分支或受控目录下执行。
- **严禁**：跨越分配范围修改 `README.md` 或全站索引（这些由 Runner 统一处理）。

### 第三阶段：增量合并（Incremental Merge）
- 采用 **“先加后连”** 策略：
  1.  Agent A 提交新文件。
  2.  Agent B 提交新文件。
  3.  由一个專屬的 Runner Agent 统一读取所有新文件，更新 `README.md` 索引。

### 第四阶段：冲突消解（Conflict Resolution）
- 如果发生逻辑冲突（如两个 Agent 修改了同一个 constitution 规则）：
  - **策略**：回退至最近的 SSOT（真理來源），由 Commander 重新裁決。

---

## 3. 协作門禁（Squad Gates）

- [ ] **隔离检测**：Agent 是否修改了非授权路径的文件？
- [ ] **接口自洽**：並行任務完成後，公共 API 是否仍符合 `design.md`？
- [ ] **索引同步**：全站 README 是否已包含所有新產出的文件？

---

## 4. 實戰建議：避免“多頭指揮”

- **單點輸入**：雖然有隊伍，但對外只暴露一個 `Main Agent`（指揮官）的對話口，由它內部調度其他子 Agent。
- **工具化支撐**：推薦關注 **[Eigent](../tools/eigent-open-source-cowork.mdx)** 這樣的開源多智能體框架，它原生支持開發、搜索、文檔等角色的并行協同。
- **日誌追蹤**：要求每個 Agent 在 `agent_runs/` 下記錄自己的執行日誌，便於追蹤是誰引入了錯誤。

---

## 🔗 关联章节
- **[01 组织模型与角色分工](./01-operating-model-and-roles.mdx)**
- **[02 Playbook：从 Spec 到 PR](./02-playbook-spec-to-pr.mdx)**
