# 阿里云 + Vibe Coding 实战指南

## 前言：为什么选择阿里云 + Vibe Coding？

在 AI 编程时代，**Vibe Coding** 的核心理念是：代码是"耗材"，意图和流程才是核心。阿里云提供了完整的云基础设施，让我们能够：

- **快速验证**：用自然语言描述需求，Agent 自动完成云端部署
- **短暂性实验**：创建资源 → 验证想法 → 销毁资源（按秒计费）
- **工业级架构**：遵循 Vibe Coding 第一定律，永远追求最优解而非最方便

> **关键洞察**：云端环境比本地更适合 Vibe Coding，因为你可以随时"重置"实验环境，而不用担心污染本地系统。

---

## 一、阿里云核心服务速览

### 1.1 新手友好的服务矩阵

| 服务 | 全称 | 新手友好度 | Agent 自动化潜力 | 典型场景 |
|------|------|-----------|-----------------|----------|
| **ECS** | 云服务器 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Docker 宿主、长期运行的应用 |
| **OSS** | 对象存储 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 静态网站、文件存储、数据湖 |
| **FC** | 函数计算 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 定时任务、事件驱动、低成本 |
| **RDS** | 云数据库 | ⭐⭐⭐ | ⭐⭐⭐⭐ | 持久化数据存储 |
| **ACK** | 容器服务 | ⭐⭐ | ⭐⭐⭐⭐⭐ | 多 Agent 编排、Kubernetes 集群 |

### 1.2 Vibe Coding 推荐起步路线

**阶段 1（第 1-2 周）**：**ECS + Docker**
- 理由：最接近本地开发体验，容易理解
- 成本：按量付费约 0.1-0.5 元/小时

**阶段 2（第 3-4 周）**：**FC + OSS**
- 理由：真正体现"短暂性"理念，用完即走
- 成本：几乎为零（百万次调用免费）

**阶段 3（第 5-8 周）**：**ACK + 多 Agent**
- 理由：生产级架构，支持并行处理
- 成本：较高（适合商业项目）

---

## 二、环境准备：zcode + 阿里云 CLI

### 2.1 安装阿里云 CLI

**为什么需要 CLI？**
- Agent 可以通过脚本调用阿里云 API，而非手动点网页
- 符合 Vibe Coding 的"意图 → 代码 → 执行"范式
- 所有操作可追溯、可回滚

**自动安装脚本**（推荐使用 Agent 生成）：

```bash
# macOS/Linux
curl -s https://aliyuncli.alicdn.com/aliyun-cli-install-latest.sh | bash

# Windows (使用 PowerShell)
# 下载地址：https://aliyuncli.alicdn.com/aliyun-cli-windows-latest.zip
# 解压后添加到 PATH
```

**配置 Access Key**：

```bash
aliyun configure

# 按提示输入：
# - Access Key ID: 从阿里云控制台获取
# - Access Key Secret: 从阿里云控制台获取
# - Region: cn-hangzhou（或其他可用区）
# - Output Format: json
```

> **安全提示**：Access Key 等同于你的账号密码，切勿上传到 GitHub！建议使用 RAM 子账号并限制权限。

### 2.2 在 zcode 中集成阿里云

**zcode 的优势**：
- 支持 MCP（模型上下文协议），可以扩展云端能力
- 内置浏览器可直接访问阿里云控制台验证部署结果
- 多 Agent 统一界面，可同时调用 Claude/智谱 GLM 等模型

**快速集成步骤**：

1. **在 zcode 中打开项目**：
   ```bash
   # 在 zcode 终端中
   cd your-project
   ```

2. **配置 Claude Code**（如果使用）：
   ```json
   // 在 .claude/config.json
   {
     "providers": {
       "aliyun": {
         "type": "cli",
         "command": "aliyun"
       }
     }
   }
   ```

3. **编写意图 Prompt**：
   ```
   我要部署一个 Python Flask 应用到阿里云 ECS。
   请帮我：
   1. 生成 app.py（包含一个简单的 "Hello World" 接口）
   2. 创建 Dockerfile
   3. 用阿里云 CLI 创建一台 ECS 实例（2核4G，Ubuntu 20.04）
   4. SSH 到服务器，部署 Docker 容器
   ```

4. **观察 Agent 执行**：
   - Agent 会生成所有必要的文件
   - 调用 `aliyun ecs CreateInstance` 创建服务器
   - 自动执行部署流程

---

## 三、Docker 化部署完整流程

### 3.1 为什么选择 Docker？

在 Vibe Coding 场景中，Docker 的三大优势：

1. **环境一致性**：本地测试通过 = 云端运行正常
2. **快速销毁**：`docker rm -f $(docker ps -aq)` 一键重置环境
3. **Agent 友好**：Agent 可以生成标准化的 Dockerfile

### 3.2 标准化的 Dockerfile 模板

**Python 应用示例**：

```dockerfile
# 使用官方 Python 镜像（遵循第一定律：选最优解）
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装依赖（使用阿里云镜像加速）
RUN pip install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 5000

# 启动命令（使用 gunicorn 生产级服务器）
CMD ["gunicorn", "-b", "0.0.0.0:5000", "app:app"]
```

**Node.js 应用示例**：

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./

# 使用阿里云 npm 镜像
RUN npm install --registry=https://mirrors.aliyun.com/npm/

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
```

### 3.3 docker-compose.yml（多容器编排）

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DATABASE_URL=postgres://db:5432/myapp
    depends_on:
      - db
      - redis

  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine

volumes:
  postgres_data:
```

---

## 四、意图驱动的云端部署：完整案例

### 4.1 案例目标

**意图描述**：
> "我要创建一个简单的 Python Web API，提供一个 `/ping` 接口返回健康状态，用 Docker 打包后部署到阿里云 ECS。"

### 4.2 Agent 应该生成的文件

#### **app.py**：

```python
from flask import Flask, jsonify

app = Flask(__name__)

@app.route('/ping')
def ping():
    return jsonify({
        "status": "healthy",
        "version": "1.0.0"
    })

@app.route('/')
def index():
    return jsonify({
        "message": "Hello from Aliyun + Vibe Coding!"
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

#### **requirements.txt**：

```
Flask==3.0.0
gunicorn==21.2.0
```

#### **Dockerfile**：

```dockerfile
FROM python:3.10-slim

WORKDIR /app

RUN pip install --no-cache-dir gunicorn flask -i https://mirrors.aliyun.com/pypi/simple/

COPY app.py .

EXPOSE 5000

CMD ["gunicorn", "-b", "0.0.0.0:5000", "app:app"]
```

### 4.3 Agent 调用阿里云 API

**Python 脚本示例**（`deploy_to_aliyun.py`）：

```python
#!/usr/bin/env python3
"""
自动部署到阿里云 ECS
由 Agent 生成，人类审核
"""

import json
import subprocess
import time

def run_command(cmd):
    """运行 shell 命令"""
    print(f"执行: {cmd}")
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    print(result.stdout)
    if result.returncode != 0:
        print(f"错误: {result.stderr}")
        exit(1)
    return result.stdout

def main():
    # 1. 构建 Docker 镜像
    print("\n[1/5] 构建 Docker 镜像...")
    run_command("docker build -t my-flask-app:latest .")

    # 2. 登录阿里云容器镜像服务
    print("\n[2/5] 登录阿里云容器镜像服务...")
    run_command("aliyun cr GetLoginToken --region cn-hangzhou | docker login --username=xxx --password-stdin registry.cn-hangzhou.aliyuncs.com")

    # 3. 推送镜像
    print("\n[3/5] 推送镜像到阿里云...")
    run_command("docker tag my-flask-app:latest registry.cn-hangzhou.aliyuncs.com/your-namespace/my-flask-app:latest")
    run_command("docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/my-flask-app:latest")

    # 4. 创建 ECS 实例
    print("\n[4/5] 创建 ECS 实例...")
    instance_id = run_command("""
    aliyun ecs CreateInstance \
        --RegionId cn-hangzhou \
        --ImageId ubuntu_20_04_x64_20G_alibase_20230908.vhd \
        --InstanceType ecs.t6-c1m2.large \
        --SecurityGroupId sg-xxxxx \
        --VSwitchId vsw-xxxxx \
        --InstanceName vibe-coding-demo \
        --InternetMaxBandwidthOut 5
    """)

    instance_id = json.loads(instance_id)['InstanceId']
    print(f"ECS 实例已创建: {instance_id}")

    # 5. 等待实例启动并部署
    print("\n[5/5] 等待实例启动...")
    time.sleep(60)  # 等待 60 秒

    instance_info = run_command(f"aliyun ecs DescribeInstanceAttribute --InstanceId {instance_id}")
    public_ip = json.loads(instance_info)['PublicIpAddress']['IpAddress'][0]
    print(f"公网 IP: {public_ip}")

    # 6. SSH 到服务器并启动容器
    print("\n[6/6] 部署应用...")
    deploy_commands = f"""
    ssh root@{public_ip} '
        apt-get update && apt-get install -y docker.io
        docker pull registry.cn-hangzhou.aliyuncs.com/your-namespace/my-flask-app:latest
        docker run -d -p 5000:5000 registry.cn-hangzhou.aliyuncs.com/your-namespace/my-flask-app:latest
    '
    """
    run_command(deploy_commands)

    print(f"\n✅ 部署完成！访问 http://{public_ip}:5000/ping 查看结果")

if __name__ == "__main__":
    main()
```

### 4.4 执行部署

在 **zcode** 中：

```bash
# 1. Agent 生成上述文件

# 2. 人类审核（关键！）
cat app.py
cat Dockerfile
cat deploy_to_aliyun.py

# 3. 执行部署
python3 deploy_to_aliyun.py
```

---

## 五、成本优化策略

### 5.1 按量付费 vs 包年包月

| 场景 | 推荐方案 | 理由 |
|------|---------|------|
| 学习实验 | **按量付费** | 随时释放，成本可控 |
| 长期运行 | **包年包月** | 节省约 40% |
| 突发流量 | **函数计算** | 按调用次数计费 |

### 5.2 成本参考（华东 1 区）

| 资源 | 配置 | 按量付费 | 包年包月 |
|------|------|---------|---------|
| ECS | 2核4G | 0.35 元/小时 | 145 元/月 |
| OSS | 标准存储 | 0.12 元/GB/月 | - |
| FC | 内存 512MB | 0.000031 元/调用 | - |

### 5.3 自动释放资源脚本

```bash
#!/bin/bash
# cleanup.sh - 一键清理所有资源

echo "正在释放 ECS 实例..."
aliyun ecs DeleteInstance --InstanceId i-xxxxx --Force true

echo "正在清空 OSS Bucket..."
aliyun oss rm oss://my-bucket --recursive -f

echo "✅ 清理完成！"
```

---

## 六、常见问题与调试

### Q1：Agent 创建的 ECS 无法访问？
**解决方案**：
1. 检查安全组是否开放端口（如 5000）
2. 确认实例已分配公网 IP
3. 在 ECS 内运行 `docker ps` 确认容器运行正常

### Q2：Docker 构建失败？
**解决方案**：
1. 检查 `requirements.txt` 依赖版本兼容性
2. 使用阿里云镜像加速（已在模板中配置）
3. 查看构建日志：`docker build --progress=plain .`

### Q3：成本超预算？
**解决方案**：
1. 设置阿里云费用告警（>100 元通知）
2. 使用函数计算代替 ECS（按调用计费）
3. 实验完成后立即释放资源

---

## 七、下一步行动

1. **本周目标**：
   - [ ] 注册阿里云账号并创建 Access Key
   - [ ] 安装阿里云 CLI 和 Docker
   - [ ] 用 zcode 完成第一个"意图 → 云端"部署

2. **推荐阅读**：
   - [Docker Mastery for Agents](/docs/tools/docker-mastery-for-agents)
   - [Agent Execution Environment: Cloud vs Local](/docs/capabilities/agent-execution-environment-cloud-vs-local)
   - [实战案例：阿里云部署](/docs/case-studies/aliyun-vibe-coding-deployment)

3. **加入社区**：
   - 提交你的实战案例到本仓库
   - 在 Issues 中分享踩坑经验

---

## 附录：资源链接

- **阿里云官方文档**：https://help.aliyun.com/
- **阿里云 CLI GitHub**：https://github.com/aliyun/aliyun-cli
- **Docker 官方文档**：https://docs.docker.com/
- **zcode 平台**：https://zcode.zhipuai.cn

---

> **Vibe Coding 第一定律实践**：本文档所有方案都追求"工业级、标准、鲁棒"，而非"最快速完成"。让 AI 承担繁琐的配置工作，人类专注业务意图。
