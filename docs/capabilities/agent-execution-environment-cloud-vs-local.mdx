# Agent 执行环境：云端沙箱全权限 vs 本地受控执行（选型与折中）

> 目标：把“体验差异”提纯为可执行的产品/工程选型 checklist。

---

## 1. 两条路线的定义

### 1.1 云端沙箱（Cloud Sandbox, Full Permission in Sandbox）
- Agent 在云端的隔离 Ubuntu/容器/VM 内执行。
- **默认权限更大**（在沙箱内），用户更少被打断。

### 1.2 本地受控执行（Local Execution, Guarded Permission）
- Agent 在用户本地或受控环境中执行。
- **默认拒绝**，通过白名单/逐步授权获得能力。

---

## 2. 体验差异的根因：权限模型

- 云端沙箱：**隔离换放行**（沙箱权限大，但与真实资产隔离）
- 本地受控：**贴近真实换谨慎**（能直接碰私有 repo/凭证/环境，因此必须收紧）

---

## 3. 什么时候选哪条路（决策树）

### 3.1 更适合云端沙箱的场景
- [ ] 一次性任务、可丢弃环境（爬数据、批处理、临时代码生成）
- [ ] 追求“丢过去就走人”的异步体验
- [ ] 不需要接触私有凭证/内部网络/本地文件系统

### 3.2 更适合本地受控执行的场景
- [ ] 私有代码库与敏感资产（公司 repo、证书、token）
- [ ] 强依赖本地真实环境（本地依赖、硬件、内网服务）
- [ ] 合规/审计要求高，需要“人类始终在环”

---

## 4. 关键 trade-offs（工程维度）

| 维度 | 云端沙箱 | 本地受控 |
| :--- | :--- | :--- |
| 体验 | 更像异步外包，少打断 | 更像结对编程，常授权 |
| 安全 | 隔离强，但要防数据外流 | 资产近，但权限可控 |
| 上下文 | 默认缺少本地上下文 | 天然贴近真实 repo |
| 成本 | 云资源与运维成本更高 | 成本更低但用户注意力成本更高 |

---

## 5. 折中方案：把“烦人的授权”变少

### 5.1 白名单分层（减少逐次确认）
- [ ] 只对白名单目录授权（例如：repo 根目录）
- [ ] 只允许执行白名单命令（例如：lint/test/build）
- [ ] 明确网络访问策略（默认无网/仅允许特定域名）

### 5.2 幂等安全墙（把高风险动作关进确定逻辑）
- [ ] 把危险操作（写入/删除/发布）封装为脚本/工具（可审计、可回放）
- [ ] Agent 只做“决策与调度”，执行交给可控脚本

### 5.3 异步回传（减少用户陪跑）
- [ ] 长任务拆成阶段性 checkpoint（每阶段给出可验收产物）
- [ ] 允许用户“离开”，但在关键动作（写入/执行/外联）前再确认

---

## 6. 给产品/工程团队的结论

- 如果你卖的是“魔法般的交付体验”，云端沙箱更像默认答案。
- 如果你卖的是“在真实仓库里可靠交付”，本地受控更像默认答案。
- 最优解通常不是二选一，而是：**沙箱做重活，本地做最后一公里；权限用白名单与幂等工具收口。**
