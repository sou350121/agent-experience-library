# 04 Playbook：风险治理与回滚（Risk & Rollback）

> 目标：把“出事概率”变成“可控流程”。建立面向真实世界的安全刹车机制，确保 Agent 的破坏性操作可追溯、可阻断、可恢复。

---

## 🧠 核心洞见

> **“不具备回滚能力的 Agent 管理，本质上是在裸奔。”**

在大规模 Agent 治理中，我们必须假设 **“Agent 一定会犯错”**（物理損毀、邏輯崩潰、權限溢出）。管理者的職責不是祈禱模型不犯錯，而是確保錯誤發生時的 **MTTR（平均修復時間）趨近於零**。

---

## 1. 风险分级（Risk Classification）

| 级别 | 描述 | 管理策略 | 門禁要求 |
| :--- | :--- | :--- | :--- |
| **L1 (低)** | 僅新增文檔、修正拼寫、更新註釋 | 自動化執行 | Runner 自檢 |
| **L2 (中)** | 修改邏輯代碼、更新依賴版本、變更配置 | 隔離執行 + Review | 人類/Reviewer 簽名 |
| **L3 (高)** | 數據庫遷移、刪除文件、操作憑證、權限提升 | 必須有備份 + 影子測試 | Commander 授權 |

---

## 2. 安全防護導軌（Safety Rails）

### 2.1 權限最小化（Least Privilege）
- **策略**：默認拒絕 (Default Deny)。
- **實作**：Agent 不應具備 `rm -rf` 或修改 `.env` 的權限，除非顯式授權。

### 2.2 隔離執行（Sandboxing）
- **策略**：在隔離的容器、VM 或分支中執行。
- **檢查點**：執行完畢後，由 Guard Agent 掃描 Diff，確保無惡意代碼注入。

### 2.3 審計日誌（Audit Trail）
- **策略**：所有 `Terminal` 命令、`File Edit` 和 `Tool Call` 必須留痕。
- **存儲**：推薦存放在 `agent_runs/YYYY-MM-DD-task-id.log`。

---

## 3. 回滾協議（Rollback Protocol）

### 3.1 預案設計（Pre-rollback Plan）
在執行任何 L2/L3 任務前，Agent 必須回答：
- **“如果失敗了，我該如何恢復到 1 分鐘前的狀態？”**
- **方案 A**：`git reset --hard HEAD` (代碼級)。
- **方案 B**：數據庫快照恢復 (數據級)。
- **方案 C**：刪除新增的臨時文件。

### 3.2 觸發條件
- 測試失敗率 > 0%
- 發生未預期的文件刪除
- 監視器檢測到 Amax 爆炸（針對模型架構任務，見 mHC 案例）

### 3.3 執行步驟（The Big Red Button）
1.  **中斷執行**：殺死所有正在運行的 Agent 進程。
2.  **狀態恢復**：執行預案 A/B。
3.  **現場保護**：保留失敗日誌用於復盤。
4.  **通知與復盤**：發送 Alert 給人類指揮官。

---

## 4. 實戰清單：發布前檢查

- [ ] **備份確認**：目標文件/數據庫是否已有備份？
- [ ] **回滾命令**：回滾指令是否已在當前環境驗證有效？
- [ ] **權限審計**：任務是否申請了超出必要的權限？
- [ ] **爆炸半徑**：如果出錯，受影響的範圍是否在隔離區內？

---

## 🔗 关联章节
- **[02 Playbook：从 Spec 到 PR](./02-playbook-spec-to-pr.mdx)**
- **[安全与防御](../security/README.md)**
- **[DeepSeek mHC 複現分析：防止信號爆炸](../../blog/2026-01-19-ken-goldberg-robotics-wisdom.md)**
